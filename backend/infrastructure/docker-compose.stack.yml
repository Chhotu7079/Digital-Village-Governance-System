version: "3.9"

# Full DVGS stack: infrastructure + Spring Boot Admin + microservices
# Usage:
#   cd backend/infrastructure
#   docker compose --env-file .env -f docker-compose.stack.yml up -d --build

x-common-env: &common-env
  ADMIN_SERVER_URL: ${ADMIN_SERVER_URL}
  ACTUATOR_USER: ${ACTUATOR_USER}
  ACTUATOR_PASS: ${ACTUATOR_PASS}

  POSTGRES_HOST: ${POSTGRES_HOST}
  POSTGRES_PORT: ${POSTGRES_PORT}
  POSTGRES_USER: ${POSTGRES_USER}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  POSTGRES_SSLMODE: ${POSTGRES_SSLMODE}

  REDIS_HOST: ${REDIS_HOST}
  REDIS_PORT: ${REDIS_PORT}

  KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
  KAFKA_TOPIC_NOTIFICATION_EVENTS: ${KAFKA_TOPIC_NOTIFICATION_EVENTS}

  RABBITMQ_HOST: ${RABBITMQ_HOST}
  RABBITMQ_PORT: ${RABBITMQ_PORT}
  RABBITMQ_USER: ${RABBITMQ_USER}
  RABBITMQ_PASS: ${RABBITMQ_PASS}

  MINIO_ENDPOINT: ${MINIO_ENDPOINT}
  MINIO_BUCKET_ATTACHMENTS: ${MINIO_BUCKET_ATTACHMENTS}
  MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
  MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}

  AUTH_JWT_SECRET: ${AUTH_JWT_SECRET}
  AUTH_JWT_ISSUER: ${AUTH_JWT_ISSUER}
  AUTH_ISSUER_URI: ${AUTH_ISSUER_URI}
  AUTH_SERVICE_BASE_URL: ${AUTH_SERVICE_BASE_URL}

x-service-defaults: &service-defaults
  restart: unless-stopped
  env_file:
    - .env
  networks:
    - dvgs

x-spring-service-defaults: &spring-service-defaults
  <<: *service-defaults
  environment:
    <<: *common-env
  depends_on:
    postgres:
      condition: service_healthy
    kafka:
      condition: service_healthy
    redis:
      condition: service_healthy
    admin-server:
      condition: service_healthy

services:
  # ---------------- Infrastructure ----------------
  postgres:
    image: postgres:16-alpine
    container_name: dvgs-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - dvgs_postgres_data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - dvgs

  redis:
    image: redis:7-alpine
    container_name: dvgs-redis
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - dvgs_redis_data:/data
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - dvgs

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: dvgs-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/2181'" ]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - dvgs

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: dvgs-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # Internal listener for other containers + external listener for host machine
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
      # IMPORTANT: never advertise localhost to other containers
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://host.docker.internal:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 30s
      retries: 20
    networks:
      - dvgs

  kafka-init:
    image: confluentinc/cp-kafka:7.6.1
    container_name: dvgs-kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_TOPIC_NOTIFICATION_EVENTS: ${KAFKA_TOPIC_NOTIFICATION_EVENTS}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo "Creating topic: $KAFKA_TOPIC_NOTIFICATION_EVENTS"
        kafka-topics --bootstrap-server "$KAFKA_BOOTSTRAP_SERVERS" \
          --create --if-not-exists \
          --topic "$KAFKA_TOPIC_NOTIFICATION_EVENTS" \
          --replication-factor 1 \
          --partitions 3
        echo "Kafka topic ensured: $KAFKA_TOPIC_NOTIFICATION_EVENTS"
    networks:
      - dvgs

  rabbitmq:
    image: rabbitmq:3-management
    container_name: dvgs-rabbitmq
    ports:
      - "${RABBITMQ_PORT}:5672"
      - "${RABBITMQ_MGMT_PORT}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS}
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 12
    networks:
      - dvgs

  minio:
    image: minio/minio:RELEASE.2024-12-13T22-19-12Z
    container_name: dvgs-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - dvgs_minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 12
    networks:
      - dvgs

  minio-init:
    image: minio/mc:RELEASE.2024-11-17T19-35-25Z
    container_name: dvgs-minio-init
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET_ATTACHMENTS: ${MINIO_BUCKET_ATTACHMENTS}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        mc alias set dvgs http://minio:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD"
        mc mb --ignore-existing "dvgs/$MINIO_BUCKET_ATTACHMENTS"
        echo "MinIO bucket ensured: $MINIO_BUCKET_ATTACHMENTS"
    networks:
      - dvgs

  # ---------------- Build once (all jars) ----------------
  backend-build:
    build:
      context: ..
      dockerfile: docker/Dockerfile.maven-monorepo
    image: dvgs/backend:dev
    container_name: dvgs-backend-build
    command: ["sh", "-c", "echo 'Build image dvgs/backend:dev created' && sleep infinity"]
    profiles: ["build"]
    networks:
      - dvgs

  # ---------------- Spring Boot Admin ----------------
  admin-server:
    <<: *service-defaults
    image: dvgs/backend:dev
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      <<: *common-env
      SERVICE_JAR: admin-server
      SERVER_PORT: 8088
      ADMIN_USER: ${ADMIN_USER}
      ADMIN_PASS: ${ADMIN_PASS}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -u ${ADMIN_USER}:${ADMIN_PASS} http://localhost:8088/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 180s
    container_name: dvgs-admin-server
    ports:
      - "${ADMIN_SERVER_PORT}:8088"

  # ---------------- Microservices ----------------
  api-gateway:
    <<: *spring-service-defaults
    image: dvgs/backend:dev
    environment:
      <<: *common-env
      SERVICE_JAR: api-gateway
      SERVER_PORT: 8080
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -u ${ACTUATOR_USER}:${ACTUATOR_PASS} http://localhost:8080/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 180s
    container_name: dvgs-api-gateway
    ports:
      - "${GATEWAY_PORT}:8080"

  auth-service:
    <<: *spring-service-defaults
    image: dvgs/backend:dev
    environment:
      <<: *common-env
      SERVICE_JAR: auth-service
      SERVER_PORT: 8081
      POSTGRES_DB: ${POSTGRES_DB_AUTH}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -u ${ACTUATOR_USER}:${ACTUATOR_PASS} http://localhost:8081/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 180s
    container_name: dvgs-auth-service
    ports:
      - "${AUTH_PORT}:8081"

  complaint-service:
    <<: *spring-service-defaults
    image: dvgs/backend:dev
    environment:
      <<: *common-env
      SERVICE_JAR: complaint-service
      SERVER_PORT: 8082
      POSTGRES_DB: ${POSTGRES_DB_COMPLAINT}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -u ${ACTUATOR_USER}:${ACTUATOR_PASS} http://localhost:8082/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 180s
    container_name: dvgs-complaint-service
    ports:
      - "${COMPLAINT_PORT}:8082"

  notification-service:
    <<: *spring-service-defaults
    image: dvgs/backend:dev
    environment:
      <<: *common-env
      SERVICE_JAR: notification-service
      SERVER_PORT: 8083
      POSTGRES_DB: ${POSTGRES_DB_NOTIFICATION}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -u ${ACTUATOR_USER}:${ACTUATOR_PASS} http://localhost:8083/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 180s
    container_name: dvgs-notification-service
    ports:
      - "${NOTIFICATION_PORT}:8083"

  scheme-service:
    <<: *spring-service-defaults
    image: dvgs/backend:dev
    environment:
      <<: *common-env
      SERVICE_JAR: scheme-service
      SERVER_PORT: 8084
      POSTGRES_DB: ${POSTGRES_DB_SCHEME}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -u ${ACTUATOR_USER}:${ACTUATOR_PASS} http://localhost:8084/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 180s
    container_name: dvgs-scheme-service
    ports:
      - "${SCHEME_PORT}:8084"

  land-service:
    <<: *spring-service-defaults
    image: dvgs/backend:dev
    environment:
      <<: *common-env
      SERVICE_JAR: land-service
      SERVER_PORT: 8085
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -u ${ACTUATOR_USER}:${ACTUATOR_PASS} http://localhost:8085/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 180s
    container_name: dvgs-land-service
    ports:
      - "${LAND_PORT}:8085"

  ration-service:
    <<: *spring-service-defaults
    image: dvgs/backend:dev
    environment:
      <<: *common-env
      SERVICE_JAR: ration-service
      SERVER_PORT: 8086
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -u ${ACTUATOR_USER}:${ACTUATOR_PASS} http://localhost:8086/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 180s
    container_name: dvgs-ration-service
    ports:
      - "${RATION_PORT}:8086"

networks:
  dvgs:
    name: dvgs

volumes:
  dvgs_postgres_data:
  dvgs_redis_data:
  dvgs_minio_data:
